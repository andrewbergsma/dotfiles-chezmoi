# ~/.config/tmux/common.conf
# ============================================================================
# SHARED TMUX SETTINGS - Same across all machines
# ============================================================================

# ============================================================================
# PLUGINS (managed by tpm)
# ============================================================================
set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-yank'
set -g @plugin 'tmux-plugins/tmux-resurrect'
set -g @plugin 'tmux-plugins/tmux-continuum'
set -g @plugin 'fcsonline/tmux-thumbs'
set -g @plugin 'sainnhe/tmux-fzf'
set -g @plugin 'wfxr/tmux-fzf-url'
set -g @plugin 'omerxx/tmux-floax'
set -g @plugin 'alexwforsythe/tmux-which-key'

# ============================================================================
# TERMINAL & DISPLAY
# ============================================================================
set -g default-terminal "tmux-256color"

# True color support
set -ag terminal-overrides ",xterm-256color:RGB"
set -ag terminal-overrides ",*256col*:RGB"
set -ag terminal-overrides ",alacritty:RGB"
set -ag terminal-overrides ",screen-256color:RGB"
set -ga terminal-overrides ",*256col*:Tc"
set -ga terminal-overrides ",kitty:Tc"

# Extended keys
set -s extended-keys on
set -g extended-keys always
set -g xterm-keys on

# ============================================================================
# CLIPBOARD - Cross-Platform (macOS/Linux/SSH)
# ============================================================================
set -g set-clipboard on
set -g allow-passthrough on

# tmux-yank configuration
set -g @yank_selection 'clipboard'
set -g @yank_selection_mouse 'clipboard'
set -g @yank_action 'copy-pipe-and-cancel'
set -g @override_copy_command ''  # Auto-detect: pbcopy/xclip/xsel/wl-copy/OSC52

# vi-style navigation
setw -g mode-keys vi

# Mouse support
set -g mouse on

# vi-style copy mode bindings
bind -T copy-mode-vi v send -X begin-selection
bind -T copy-mode-vi C-v send -X rectangle-toggle
bind -T copy-mode-vi y send -X copy-selection-and-cancel
bind -T copy-mode-vi Escape send -X cancel

# Copy mode scrolling (Alt-based to avoid conflicts)
bind -T copy-mode-vi M-y send -X scroll-up
bind -T copy-mode-vi M-e send -X scroll-down
bind -T copy-mode-vi M-u send -X halfpage-up
bind -T copy-mode-vi M-d send -X halfpage-down
bind -T copy-mode-vi M-b send -X page-up
bind -T copy-mode-vi M-f send -X page-down

# Fix Shift+Tab
bind -n BTab send-keys Escape "[Z"

# ============================================================================
# SESSION PERSISTENCE
# ============================================================================
set -g @resurrect-capture-pane-contents 'on'
set -g @resurrect-strategy-nvim 'session'
set -g @resurrect-processes 'micro vim nvim htop btop ssh'

set -g @continuum-restore 'on'
set -g @continuum-save-interval '10'

# ============================================================================
# PLUGIN SETTINGS
# ============================================================================
# tmux-thumbs
set -g @thumbs-key f
set -g @thumbs-alphabet qwerty
set -g @thumbs-unique enabled
set -g @thumbs-position off_left
set -g @thumbs-contrast 1
set -g @thumbs-regexp-1 '[a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}'
set -g @thumbs-regexp-2 '\b[0-9]{1,5}\b'

# tmux-fzf
set-environment -g TMUX_FZF_LAUNCH_KEY "C-f"
set-environment -g TMUX_FZF_ORDER "session|window|pane|command|keybinding|clipboard|process"
set-environment -g TMUX_FZF_PREVIEW "1"
set-environment -g TMUX_FZF_OPTIONS "-p -w 80% -h 70% -m"

# tmux-fzf-url
set -g @fzf-url-bind 'u'
set -g @fzf-url-fzf-options '-p 60% -w 50% --multi --reverse'
set -g @fzf-url-history-limit '2000'

# tmux-floax
set -g @floax-bind 'g'
set -g @floax-bind-menu 'G'
set -g @floax-width '80%'
set -g @floax-height '80%'
set -g @floax-change-path 'true'

# ============================================================================
# GENERAL SETTINGS
# ============================================================================
set -g base-index 1
setw -g pane-base-index 1
set -g renumber-windows on
set -g history-limit 50000
set -s escape-time 0
set -g focus-events on
set -g display-time 4000

# Prefix key
set -g prefix C-b
bind C-b send-prefix

# ============================================================================
# KEY BINDINGS
# ============================================================================
# Pane navigation (vim-style) - Smart navigation that detects vim/nvim only
# Note: yazi uses plain h/j/k/l, so C-h/j/k/l should always switch panes
is_vim="sh ~/.config/tmux/scripts/is_vim.sh"
is_vim_or_yazi="sh ~/.config/tmux/scripts/is_vim_or_yazi.sh"
bind -n C-h if-shell "$is_vim" 'send-keys C-h' 'select-pane -L'
bind -n C-j if-shell "$is_vim" 'send-keys C-j' 'select-pane -D'
bind -n C-k if-shell "$is_vim" 'send-keys C-k' 'select-pane -U'
bind -n C-l if-shell "$is_vim" 'send-keys C-l' 'select-pane -R'

# Pane resizing (prefix + vim keys)
bind -r h resize-pane -L 5
bind -r j resize-pane -D 5
bind -r k resize-pane -U 5
bind -r l resize-pane -R 5

# Window switching (Alt+number)
bind -n M-1 select-window -t 1
bind -n M-2 select-window -t 2
bind -n M-3 select-window -t 3
bind -n M-4 select-window -t 4
bind -n M-5 select-window -t 5
bind -n M-6 select-window -t 6
bind -n M-7 select-window -t 7
bind -n M-8 select-window -t 8
bind -n M-9 select-window -t 9

# Window navigation (Alt+h/l and Alt+arrows) - Don't interfere with vim/nvim/yazi
bind -n M-h if-shell "$is_vim_or_yazi" 'send-keys M-h' 'previous-window'
bind -n M-l if-shell "$is_vim_or_yazi" 'send-keys M-l' 'next-window'
bind -n M-Left if-shell "$is_vim_or_yazi" 'send-keys M-Left' 'previous-window'
bind -n M-Right if-shell "$is_vim_or_yazi" 'send-keys M-Right' 'next-window'

# Pane splitting (Alt+\ and Alt+-)
bind -n M-\\ split-window -h -c "#{pane_current_path}"
bind -n M-- split-window -v -c "#{pane_current_path}"

# Copy mode (Alt+[ or Alt+Escape) - Don't trigger in vim/nvim/yazi
bind -n M-[ if-shell "$is_vim_or_yazi" 'send-keys M-[' 'copy-mode'
bind -n M-Escape if-shell "$is_vim_or_yazi" 'send-keys M-Escape' 'copy-mode'

# Window creation (Alt+c)
bind -n M-c new-window -c "#{pane_current_path}"

# Zoom toggle (Alt+z)
bind -n M-z resize-pane -Z

# Session management (Alt+s)
bind -n M-s choose-session

# Session switching (Alt+k/j, vim-style) - Don't interfere with vim/nvim/yazi
bind -n M-k if-shell "$is_vim_or_yazi" 'send-keys M-k' 'switch-client -p'
bind -n M-j if-shell "$is_vim_or_yazi" 'send-keys M-j' 'switch-client -n'

# Kill pane/window (Alt+x/X)
bind -n M-x confirm-before -p "Kill pane? (y/n)" kill-pane
bind -n M-X confirm-before -p "Kill window? (y/n)" kill-window

# Splitting
bind | split-window -h -c "#{pane_current_path}"
bind - split-window -v -c "#{pane_current_path}"

# Zoom and layouts
bind z resize-pane -Z
bind = select-layout even-horizontal
bind + select-layout even-vertical

# Window/session management
bind c new-window -c "#{pane_current_path}"
bind S choose-session
bind N command-prompt -p "Session name:" "new-session -s '%%'"

# Kill commands with confirmation
bind x confirm-before -p "Kill pane? (y/n)" kill-pane
bind X confirm-before -p "Kill window? (y/n)" kill-window
bind Q confirm-before -p "Kill session? (y/n)" kill-session

# Reload configuration
bind r source-file ~/.tmux.conf \; display-message "Config reloaded!"

# Synchronize panes
bind C-y setw synchronize-panes \; display-message "Synchronize: #{?pane_synchronized,ON,OFF}"

# Pane/window info
bind i display-panes
bind I display-message "Session: #S | Window: #I:#W | Pane: #P"

# Help
bind ? display-popup -E -w 90% -h 90% "~/.config/tmux/scripts/help.sh"
bind -n M-? display-popup -E -w 90% -h 90% "~/.config/tmux/scripts/help.sh"
bind M-k list-keys

# Quick terminals
bind t split-window -v -c "#{pane_current_path}" -l 10
bind T new-window -c "#{pane_current_path}" -n htop "htop"

# ============================================================================
# ACTIVITY & NOTIFICATIONS
# ============================================================================
setw -g monitor-activity on
set -g visual-activity off
set -g visual-bell off
set -g bell-action none
