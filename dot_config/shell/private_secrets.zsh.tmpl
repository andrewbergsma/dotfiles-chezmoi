#!/usr/bin/env zsh
# ============================================================================
# SECRETS MANAGEMENT
# ============================================================================
# macOS: Fetches secrets from Keychain
# Linux: Sources from manually maintained env file
#
# To add secrets on macOS:
#   security add-generic-password -a "service-name" -s "key-name" -w "value"
#
# To add secrets on Linux:
#   Create ~/.config/shell/secrets.env with KEY=value pairs
# ============================================================================

{{- if eq .chezmoi.os "darwin" }}
# ============================================================================
# macOS - Keychain Integration
# ============================================================================

# Helper function to safely fetch from keychain
_fetch_keychain() {
    local account="$1"
    local service="$2"
    local value=$(security find-generic-password -a "$account" -s "$service" -w 2>/dev/null)
    echo "$value"
}

# GitHub Token
_gh_token=$(_fetch_keychain "github" "personal-token")
[[ -n "$_gh_token" ]] && export GITHUB_TOKEN="$_gh_token"

# OpenAI API Key
_openai_key=$(_fetch_keychain "openai" "api-key")
[[ -n "$_openai_key" ]] && export OPENAI_API_KEY="$_openai_key"

# Anthropic API Key
_anthropic_key=$(_fetch_keychain "anthropic" "api-key")
[[ -n "$_anthropic_key" ]] && export ANTHROPIC_API_KEY="$_anthropic_key"

# Add more secrets here following the same pattern:
# _my_secret=$(_fetch_keychain "account-name" "service-name")
# [[ -n "$_my_secret" ]] && export MY_SECRET="$_my_secret"

# Cleanup
unset _fetch_keychain
unset _gh_token _openai_key _anthropic_key

{{- else }}
# ============================================================================
# Linux - Manual Environment File
# ============================================================================
# Source secrets from ~/.config/shell/secrets.env if it exists
# This file should be manually created and is NOT managed by chezmoi

if [[ -f ~/.config/shell/secrets.env ]]; then
    # Source the file, stripping comments and empty lines
    while IFS= read -r line || [[ -n "$line" ]]; do
        # Skip comments and empty lines
        [[ "$line" =~ ^[[:space:]]*# ]] && continue
        [[ -z "${line// }" ]] && continue

        # Export the variable
        export "$line"
    done < ~/.config/shell/secrets.env
else
    # Create template file if it doesn't exist
    mkdir -p ~/.config/shell
    cat > ~/.config/shell/secrets.env << 'EOF'
# ============================================================================
# SECRETS - Manually maintained on {{ .chezmoi.hostname }}
# ============================================================================
# Add your secrets here in KEY=value format
# Lines starting with # are ignored
#
# Example:
# GITHUB_TOKEN=ghp_xxxxxxxxxxxx
# OPENAI_API_KEY=sk-xxxxxxxxxxxx
# ANTHROPIC_API_KEY=sk-ant-xxxxxxxxxxxx

EOF
    echo "Created template: ~/.config/shell/secrets.env"
    echo "Add your secrets and reload your shell."
fi
{{- end }}
